<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container" style="text-align: center; padding-top: 100px">
      <h1>Thank You!</h1>
      <p id="message">Processing your booking, please wait...</p>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const messageEl = document.getElementById("message");
        const checkIn = localStorage.getItem("pending_booking_checkIn");
        const checkOut = localStorage.getItem("pending_booking_checkOut");

        // Obtenemos el ID de la sesiÃ³n de Stripe desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session_id");

        if (checkIn && checkOut && sessionId) {
          try {
            const response = await fetch("/api/bookings", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                checkIn,
                checkOut,
                stripePaymentId: sessionId,
              }), // ENVIAMOS EL ID DE PAGO
            });
            if (!response.ok) throw new Error("Failed to save booking.");

            localStorage.removeItem("pending_booking_checkIn");
            localStorage.removeItem("pending_booking_checkOut");
            messageEl.textContent =
              "Your booking is confirmed! Redirecting to the homepage...";
          } catch (error) {
            console.error("Error saving booking:", error);
            messageEl.textContent =
              "There was an issue confirming your booking. Please contact support.";
          }
        } else {
          messageEl.textContent =
            "Your payment was successful. Redirecting to the homepage...";
        }

        setTimeout(() => {
          window.location.href = "/";
        }, 5000);
      });
    </script>
  </body>
</html>
